# Service Bus

## Create Topic + Subscription with DLQ

### 1. Create the Service Bus Topic

```bash
az servicebus topic create \
  --resource-group Connectivity-Zone-RG \
  --namespace-name is-servicebus \
  --name testmessagetopic \
  --enable-batched-operations true \
  --max-size 1024 \
  --default-message-time-to-live P7D \
  --enable-partitioning true
```

#### Highlights:

- --max-size 1024 → 1 GB topic size

- --default-message-time-to-live P7D → messages expire after 7 days

- --enable-partitioning true → improves throughput and resilience

##

### 2. Create the Subscription with Retry + DLQ Settings

```bash
az servicebus topic subscription create \
  --resource-group Connectivity-Zone-RG \
  --namespace-name is-servicebus \
  --topic-name testmessagetopic \
  --name testsubscribe \
  --max-delivery-count 3 \
  --default-message-time-to-live P3D \
  --dead-letter-on-filter-exceptions true \
  --enable-dead-lettering-on-message-expiration true
```

#### Highlights:

- --max-delivery-count 3 → message retried 3 times before DLQ

- --dead-letter-on-filter-exceptions true → DLQ on rule/filter errors

- --enable-dead-lettering-on-message-expiration true → DLQ on TTL expiry

##

### 3. Verify DLQ Behavior

#### To inspect DLQ messages:

```bash
az servicebus topic subscription show \
  --resource-group Connectivity-Zone-RG \
  --namespace-name is-servicebus \
  --topic-name testmessagetopic \
  --name testsubscribe
```

#### To read from DLQ programmatically:

```javascript
const receiver = sbClient.createReceiver("bookingmessagetopic", "bookingsubscribe", {
  subQueueType: "deadLetter"
});
```

##

## Operational Signals for Azure Service Bus Topics

| Signal | Strategy |
|--------|----------|
| **Retry** | Controlled via `max-delivery-count` on the subscription. Messages are retried until the threshold is reached. |
| **DLQ (Dead Letter Queue)** | Triggered when messages expire (TTL), exceed retry limits, or encounter filter exceptions. |
| **TTL (Time to Live)** | Set per topic and subscription using ISO 8601 duration format (e.g., `P7D` for 7 days, `P3D` for 3 days). |
| **Audit** | Use `applicationProperties` and `subject` fields in messages to embed metadata for traceability and compliance. |

### Example: Message Metadata for Audit

```json
{
  "body": { "orderId": "ORD-2025-001" },
  "subject": "NewBooking",
  "applicationProperties": {
    "source": "invoice-generator",
    "priority": "high",
    "region": "IN"
  }
}
