# Service Bus

## Create Topic + Subscription with DLQ

### 1. Create the Service Bus Topic

```bash
az servicebus topic create \
  --resource-group Connectivity-Zone-RG \
  --namespace-name is-servicebus \
  --name testmessagetopic \
  --enable-batched-operations true \
  --max-size 1024 \
  --default-message-time-to-live P7D \
  --enable-partitioning true
```

#### Highlights:

- --max-size 1024 → 1 GB topic size

- --default-message-time-to-live P7D → messages expire after 7 days

- --enable-partitioning true → improves throughput and resilience

##

### 2. Create the Subscription with Retry + DLQ Settings

```bash
az servicebus topic subscription create \
  --resource-group Connectivity-Zone-RG \
  --namespace-name is-servicebus \
  --topic-name testmessagetopic \
  --name testsubscribe \
  --max-delivery-count 3 \
  --default-message-time-to-live P3D \
  --dead-letter-on-filter-exceptions true \
  --enable-dead-lettering-on-message-expiration true
```

#### Highlights:

- --max-delivery-count 3 → message retried 3 times before DLQ

- --dead-letter-on-filter-exceptions true → DLQ on rule/filter errors

- --enable-dead-lettering-on-message-expiration true → DLQ on TTL expiry

##

### 3. Verify DLQ Behavior

#### To inspect DLQ messages:

```bash
az servicebus topic subscription show \
  --resource-group Connectivity-Zone-RG \
  --namespace-name is-servicebus \
  --topic-name testmessagetopic \
  --name testsubscribe
```

#### To read from DLQ programmatically:

```javascript
const receiver = sbClient.createReceiver("bookingmessagetopic", "bookingsubscribe", {
  subQueueType: "deadLetter"
});
```

##

## Operational Signals for Azure Service Bus Topics

| Signal | Strategy |
|--------|----------|
| **Retry** | Controlled via `max-delivery-count` on the subscription. Messages are retried until the threshold is reached. |
| **DLQ (Dead Letter Queue)** | Triggered when messages expire (TTL), exceed retry limits, or encounter filter exceptions. |
| **TTL (Time to Live)** | Set per topic and subscription using ISO 8601 duration format (e.g., `P7D` for 7 days, `P3D` for 3 days). |
| **Audit** | Use `applicationProperties` and `subject` fields in messages to embed metadata for traceability and compliance. |

### Example: Message Metadata for Audit

```json
{
  "body": { "orderId": "ORD-2025-001" },
  "subject": "NewBooking",
  "applicationProperties": {
    "source": "invoice-generator",
    "priority": "high",
    "region": "IN"
  }
}
```
##

## Azure Function: Push to Service Bus Topic

### local.settings.json

```json
{
  "IsEncrypted": false,
  "Values": {
    "AzureWebJobsStorage": "UseDevelopmentStorage=true",
    "FUNCTIONS_WORKER_RUNTIME": "node",
    "ServiceBusConnection": "Endpoint=sb://my-servicebus-namespace.servicebus.windows.net/;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=your-key",
    "ServiceBusTopic": "bookingmessagetopic"
  }
}
```

##

```javascript

const { app } = require('@azure/functions');
const { ServiceBusClient } = require('@azure/service-bus');

app.http('sendToServiceBus', {
    methods: ['POST'],
    authLevel: 'function',
    handler: async (request, context) => {
        const connectionString = process.env.ServiceBusConnection;
        const topicName = process.env.ServiceBusTopic;

        const payload = await request.json();

        const sbClient = new ServiceBusClient(connectionString);
        const sender = sbClient.createSender(topicName);

        const message = {
            body: payload,
            contentType: "application/json",
            subject: "NewBooking",
            applicationProperties: {
                source: "azure-function",
                priority: "high"
            }
        };

        try {
            await sender.sendMessages(message);
            context.log(`Message sent to topic '${topicName}'`);
            await sender.close();
            await sbClient.close();

            return { status: 200, body: "Message sent successfully." };
        } catch (err) {
            context.log.error(`Failed to send message: ${err.message}`);
            return { status: 500, body: "Failed to send message." };
        }
    }
});

```
##

### Sample HTTP Request

``` json
{
  "orderId": "ORD-2025-001",
  "customer": {
    "name": "Sivasankar Thalavai",
    "email": "siva@example.com"
  },
  "items": [
    { "sku": "SKU-123", "quantity": 2 },
    { "sku": "SKU-456", "quantity": 1 }
  ],
  "totalAmount": 1499.00,
  "currency": "INR"
}
```

##

<img width="1340" height="503" alt="image" src="https://github.com/user-attachments/assets/7e5cb813-8907-4f3a-ab7a-116c1745c539" />

##

# Azure Function: Service Bus Topic Trigger

### local.settings.json

```json
{
  "IsEncrypted": false,
  "Values": {
    "AzureWebJobsStorage": "UseDevelopmentStorage=true",
    "FUNCTIONS_WORKER_RUNTIME": "node",
    "ServiceBusConnection": "Endpoint=sb://my-servicebus-namespace.servicebus.windows.net/;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=your-key",
    "ServiceBusTopic": "bookingmessagetopic",
    "ServiceBusSubscription": "bookingsubscribe"
  }
}
```

## 

### serviceBusTopicTrigger.function.js

```javascript
const { app } = require('@azure/functions');

app.serviceBusTopic('serviceBusTopicTrigger', {
  topicName: '%ServiceBusTopic%',
  subscriptionName: '%ServiceBusSubscription%',
  connection: 'ServiceBusConnection',
  handler: async (message, context) => {
    const topic = process.env.ServiceBusTopic;
    const subscription = process.env.ServiceBusSubscription;

    context.log(`Message received from topic '${topic}' and subscription '${subscription}':`);
    context.log(message);

    // Optional: Audit-friendly metadata
    context.log(`Invocation ID: ${context.invocationId}`);
    context.log(`Function Name: ${context.executionContext.functionName}`);
  }
});
```
