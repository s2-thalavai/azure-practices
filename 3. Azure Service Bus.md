# Service Bus

## 1. What is Azure Service Bus

Azure Service Bus is a fully managed message broker for asynchronous communication between applications and services. 
It supports queues and topics:

| Feature                  | Description                                                                            |
| ------------------------ | -------------------------------------------------------------------------------------- |
| **Queue**                | Simple FIFO message delivery. One sender, one receiver (competing consumers possible). |
| **Topic + Subscription** | Publish/Subscribe model. One sender, multiple subscribers receive copies of messages.  |
| **Dead-lettering**       | Messages that cannot be delivered can go to a dead-letter queue.                       |
| **Sessions**             | Message grouping and ordered processing.                                               |


## 2. Key Components

- **Namespace** → Container for queues/topics.

- **Queue** → Messages are stored until consumed.

- **Topic** → Sender publishes messages to a topic.

- **Subscription** → Receivers subscribe to a topic.

- **Connection String** → Used by clients to connect to Service Bus.

## 3. Create Topic + Subscription with DLQ

### 1. Create Topic: notification_msg_topic

```bash
az servicebus topic create \
  --resource-group Connectivity-Zone-RG \
  --namespace-name servicebus1 \
  --name notification_msg_topic \
  --enable-batched-operations true \
  --max-size 4096 \
  --default-message-time-to-live P14D \
  --enable-partitioning true \
  --enable-express false \
  --status Active
```

##

### 2. Create DLQ Queue: notification_msg_deadletter_queue

```bash
az servicebus queue create \
  --resource-group Connectivity-Zone-RG \
  --namespace-name servicebus1 \
  --name notification_msg_deadletter_queue \
  --max-size 2048 \
  --default-message-time-to-live P14D \
  --enable-partitioning true \
  --enable-batched-operations true \
  --lock-duration PT5M \
  --status Active
```

### 3. Create Subscription: is_notification_msg_subscribe
   
```bash
az servicebus topic subscription create \
  --resource-group Connectivity-Zone-RG \
  --namespace-name servicebus1 \
  --topic-name notification_msg_topic \
  --name notification_msg_subscribe \
  --max-delivery-count 5 \
  --default-message-time-to-live P14D \
  --dead-letter-on-filter-exceptions true \
  --enable-dead-lettering-on-message-expiration true \
  --auto-delete-on-idle P30D \
  --enable-session false \
  --forward-dead-lettered-messages-to notification_msg_deadletter_queue \
  --status Active
```
##

## 4. Node.js Integration

### 4.0. local.settings.json

```json
{
  "IsEncrypted": false,
  "Values": {
    "AzureWebJobsStorage": "UseDevelopmentStorage=true",
    "FUNCTIONS_WORKER_RUNTIME": "node",
    "ServiceBusConnection": "Endpoint=sb://my-servicebus-namespace.servicebus.windows.net/;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=your-key",
    "ServiceBusTopic": "bookingmessagetopic",
    "ServiceBusSubscription": "bookingsubscribe"
  }
}
```

## 

## 4.1. Azure Function: Push to Service Bus Topic

```javascript

const { app } = require('@azure/functions');
const { ServiceBusClient } = require('@azure/service-bus');

app.http('sendToServiceBus', {
    methods: ['POST'],
    authLevel: 'function',
    handler: async (request, context) => {
        const connectionString = process.env.ServiceBusConnection;
        const topicName = process.env.ServiceBusTopic;

        const payload = await request.json();

        const sbClient = new ServiceBusClient(connectionString);
        const sender = sbClient.createSender(topicName);

        const message = {
            body: payload,
            contentType: "application/json",
            subject: "NewBooking",
            applicationProperties: {
                source: "azure-function",
                priority: "high"
            }
        };

        try {
            await sender.sendMessages(message);
            context.log(`Message sent to topic '${topicName}'`);
            await sender.close();
            await sbClient.close();

            return { status: 200, body: "Message sent successfully." };
        } catch (err) {
            context.log.error(`Failed to send message: ${err.message}`);
            return { status: 500, body: "Failed to send message." };
        }
    }
});

```

<img width="1361" height="395" alt="image" src="https://github.com/user-attachments/assets/51d44699-4d84-4732-aaa4-3a9e7792d733" />

##

### Sample HTTP Request

``` json
{
  "orderId": "ORD-2025-001",
  "customer": {
    "name": "Sivasankar Thalavai",
    "email": "siva@example.com"
  },
  "items": [
    { "sku": "SKU-123", "quantity": 2 },
    { "sku": "SKU-456", "quantity": 1 }
  ],
  "totalAmount": 1499.00,
  "currency": "INR"
}
```

##

<img width="1340" height="503" alt="image" src="https://github.com/user-attachments/assets/7e5cb813-8907-4f3a-ab7a-116c1745c539" />

##

## 4.3. Azure Function: Service Bus Topic Trigger

### serviceBusTopicTrigger.js

```javascript
const { app } = require('@azure/functions');

app.serviceBusTopic('serviceBusTopicTrigger', {
  topicName: '%ServiceBusTopic%',
  subscriptionName: '%ServiceBusSubscription%',
  connection: 'ServiceBusConnection',
  handler: async (message, context) => {
    const topic = process.env.ServiceBusTopic;
    const subscription = process.env.ServiceBusSubscription;

    context.log(`Message received from topic '${topic}' and subscription '${subscription}':`);
    context.log(message);

    // Optional: Audit-friendly metadata
    context.log(`Invocation ID: ${context.invocationId}`);
    context.log(`Function Name: ${context.executionContext.functionName}`);
  }
});
```
<img width="1357" height="542" alt="image" src="https://github.com/user-attachments/assets/2f723dd6-2b7b-451d-b5d1-2b04de096ef0" />

##

## 5. Python Integration

##  5.1. Azure Function: Push to Service Bus Topic
